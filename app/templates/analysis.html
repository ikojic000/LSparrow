{% extends "base.html" %} {# SEO: Unique page title for the analysis page #} {%
block title %}Statistička analiza CSV podataka – LSparrow{% endblock %} {# SEO:
Unique meta description for analysis page #} {% block meta_description
%}Učitajte CSV datoteku iz Google Forms-a i dobijte deskriptivnu statistiku za
pitanja na Likertovoj skali – aritmetička sredina, medijan, SD, K-S test i
više.{% endblock %} {# SEO: Open Graph overrides for analysis page #} {% block
og_title %}Statistička analiza CSV podataka – LSparrow{% endblock %} {% block
og_description %}Učitajte CSV datoteku iz Google Forms-a i dobijte deskriptivnu
statistiku za pitanja na Likertovoj skali.{% endblock %} {% block content %}
<!-- Page Header -->
<section class="page-section-header">
  <div class="container px-4 px-lg-5">
    <div class="text-center">
      <!-- SEO: Single h1 per page describing the page purpose -->
      <h1 class="section-heading text-uppercase text-white">
        Statistička analiza
      </h1>
      <hr class="divider divider-light" />
      <p class="text-white-75">
        Učitajte CSV datoteku i dobijte detaljnu statističku analizu
      </p>
    </div>
  </div>
  <!-- Decorative image: empty alt + aria-hidden is correct for non-informational images -->
  <img
    src="{{ url_for('static', filename='images/svg/peeking.svg') }}"
    alt=""
    class="peeking-sparrow"
    aria-hidden="true" />
</section>

<!-- Upload Section -->
<section class="page-section" id="upload-section">
  <div class="container px-4 px-lg-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <!-- Instructions -->
        <div class="card instruction-card mb-4">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-info-circle text-primary me-2"></i>Upute za
              korištenje
            </h5>
            <ol class="mb-0">
              <li>
                Izvezite odgovore ankete iz Google Forms-a u
                <strong>CSV formatu</strong>.
              </li>
              <li>
                Kliknite gumb <em>"Odaberi datoteku"</em> i pronađite vašu CSV
                datoteku.
              </li>
              <li>
                Kliknite <em>"Učitaj i izračunaj"</em> za pokretanje statističke
                analize.
              </li>
              <li>
                Samo pitanja s odgovorima na
                <strong>Likertovoj skali (1-5)</strong> će biti analizirana.
              </li>
            </ol>
          </div>
        </div>

        <!-- Upload Form -->
        <div class="card upload-card">
          <div class="card-body p-4">
            <form method="POST" enctype="multipart/form-data" id="uploadForm">
              <div class="mb-3">
                <label for="csv_file" class="form-label fw-bold">
                  <i class="fas fa-file-csv me-1"></i> Odaberite CSV datoteku
                </label>
                <input
                  type="file"
                  class="form-control form-control-lg"
                  id="csv_file"
                  name="csv_file"
                  accept=".csv"
                  required />
                <div class="form-text">
                  Podržane su CSV datoteke izvezene iz Google Forms-a (max 16
                  MB).
                </div>
              </div>
              <div id="fileInfo" class="alert alert-info d-none mb-3">
                <i class="fas fa-file me-2"></i>
                <span id="fileName"></span>
                <span class="ms-2 badge bg-secondary" id="fileSize"></span>
              </div>
              <button
                type="submit"
                class="btn btn-primary btn-xl text-uppercase w-100"
                id="submitBtn">
                <i class="fas fa-upload me-2"></i> Učitaj i izračunaj
              </button>
            </form>
          </div>
        </div>

        <!-- Column Selection Card (shown after file analysis via JS) -->
        <div id="columnSelectionCard" class="card mt-4 d-none">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">
              <i class="fas fa-layer-group me-2"></i>Odaberite stupce za
              grupiranje
            </h5>
          </div>
          <div class="card-body">
            <p class="text-muted mb-3">
              Odaberite stupce po kojima želite grupirati statističku analizu.
              Ako ne odaberete nijedan stupac, izračunat će se samo ukupna
              statistika.
            </p>
            <div id="columnCheckboxes"></div>
            <hr />
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="text-muted small" id="selectedCount"
                >0 od 0 odabrano</span
              >
              <div>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  id="selectAllBtn">
                  <i class="fas fa-check-double me-1"></i>Odaberi sve
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-secondary"
                  id="deselectAllBtn">
                  <i class="fas fa-times me-1"></i>Poništi sve
                </button>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-primary btn-xl"
                id="calculateBtn">
                <i class="fas fa-calculator me-2"></i>Izračunaj statistiku
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-xl"
                id="skipGroupingBtn">
                <i class="fas fa-forward me-2"></i>Bez grupiranja
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% if error %}
<!-- Error Alert -->
<section class="py-0">
  <div class="container px-4 px-lg-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div
          class="alert alert-danger alert-dismissible fade show shadow-sm"
          role="alert"
          id="errorAlert">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Greška:</strong> {{ error }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"></button>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %} {% if results %}
<!-- Results Section -->
<section class="page-section bg-light" id="results-section">
  <div class="container px-4 px-lg-5">
    <!-- Results Header -->
    <div class="text-center mb-4">
      <h2 class="section-heading text-uppercase">Rezultati analize</h2>
      <hr class="divider" />
      <h3 class="section-subheading text-muted">
        Pronađeno {{ results.overall|length }} pitanja s Likertovom skalom
      </h3>
    </div>

    {% if ai_enabled %}
    <!-- Store results as JSON for AI AJAX -->
    <script id="analysisData" type="application/json">
      {{ results | tojson }}
    </script>
    <!-- Action Buttons -->
    <div class="d-flex justify-content-end align-items-center gap-2 mb-4">
      <button class="btn btn-outline-primary" id="resetBtn">
        <i class="fas fa-redo me-2"></i>Učitaj nove podatke
      </button>
      <button
        class="btn btn-ai-analyze rounded-circle p-3"
        id="aiAnalysisBtn"
        data-bs-toggle="popover"
        data-bs-trigger="hover focus"
        data-bs-content="AI interpretacija rezultata">
        <i class="fas fa-wand-magic-sparkles"></i>
      </button>
    </div>

    <!-- AI Analysis Card (hidden until button click) -->
    <div
      class="row justify-content-center mb-4"
      id="aiCardWrapper"
      style="display: none">
      <div class="col-lg-12">
        <div class="card border-0 shadow-sm" id="aiCard">
          <div
            class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-robot me-2"></i>AI interpretacija rezultata
            </h5>
            <button
              class="btn btn-sm btn-outline-dark rounded-circle border-0"
              id="toggleAiBody"
              title="Prikaži/sakrij">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div id="aiCardBody">
            <!-- Spinner -->
            <div class="card-body text-center py-4" id="aiSpinner">
              <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Učitavanje...</span>
              </div>
              <p class="mt-2 mb-0 text-muted">Dohvaćam AI interpretaciju...</p>
            </div>
            <!-- AI Result (hidden by default) -->
            <div class="card-body" id="aiResult" style="display: none">
              <div class="card-text mb-3" id="aiResultText"></div>
              <div class="text-end">
                <button
                  class="btn btn-sm btn-outline-secondary"
                  id="copyPromptBtn">
                  <i class="fas fa-copy me-1"></i>Kopiraj AI upit
                </button>
              </div>
            </div>
            <!-- AI Error (hidden by default) -->
            <div class="card-body" id="aiError" style="display: none">
              <div class="alert alert-danger mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="aiErrorText"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <!-- Action Buttons -->
    <div class="text-end mb-4">
      <button class="btn btn-outline-primary" id="resetBtn">
        <i class="fas fa-redo me-2"></i>Učitaj nove podatke
      </button>
    </div>
    <!-- AI Disabled Notice -->
    <div class="row justify-content-center mb-4">
      <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
          <div
            class="card-header bg-secondary text-white d-flex align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-robot me-2"></i>AI interpretacija rezultata
            </h5>
          </div>
          <div class="card-body">
            <p class="card-text mb-0 text-muted">
              <i class="fas fa-info-circle me-1"></i>
              AI analiza je trenutno onemogućena. Postavite
              <code>GEMINI_AI_ENABLED=true</code> u .env datoteci za aktivaciju.
            </p>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Controls Bar -->
    <div class="row justify-content-center mb-4">
      <div class="col-lg-12">
        <div class="card controls-card">
          <div class="card-body">
            {% if results.groupings %}
            <div class="row align-items-center">
              <div class="col-md-5">
                <label for="groupingSelect" class="form-label fw-bold mb-0">
                  <i class="fas fa-filter me-2 text-primary"></i>Grupiraj
                  statistiku prema:
                </label>
              </div>
              <div class="col-md-5">
                <select class="form-select" id="groupingSelect">
                  <option value="overall" selected>
                    Ukupno (svi ispitanici)
                  </option>
                  {% for key, info in results.groupings.items() %}
                  <option value="{{ key }}">
                    {{ info.label }} ({{ info.column }})
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2 text-end">
                <button
                  class="btn btn-outline-secondary btn-sm"
                  id="toggleLegend"
                  title="Prikaži/sakrij legendu">
                  <i class="fas fa-question-circle me-1"></i>Legenda
                </button>
              </div>
            </div>
            {% else %}
            <div class="row align-items-center">
              <div class="col text-end">
                <button
                  class="btn btn-outline-secondary btn-sm"
                  id="toggleLegend"
                  title="Prikaži/sakrij legendu">
                  <i class="fas fa-question-circle me-1"></i>Legenda
                </button>
              </div>
            </div>
            {% endif %}
            <!-- Collapsible Legend -->
            <div id="legendPanel" class="mt-3" style="display: none">
              <hr />
              <div class="stats-legend">
                <span class="badge bg-dark me-1">N</span> Broj ispitanika &nbsp;
                <span class="badge bg-dark me-1">AS</span> Aritmetička sredina
                &nbsp; <span class="badge bg-dark me-1">SD</span> Standardna
                devijacija &nbsp;
                <span class="badge bg-dark me-1">Ske</span> Asimetrija &nbsp;
                <span class="badge bg-dark me-1">Kur</span> Zaobljenost &nbsp;
                <span class="badge bg-dark me-1">Max D</span> K-S statistika
                &nbsp; <span class="badge bg-dark me-1">K-S p</span> K-S
                p-vrijednost
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Overall Results -->
    <div id="section-overall" class="results-group active">
      <div class="row justify-content-center">
        <div class="col-lg-12">
          <div class="card results-table-card">
            <div
              class="card-header bg-success text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>
                Ukupna statistika ({{ results.overall|length }} pitanja)
              </h5>
              <button
                class="btn btn-sm btn-outline-light toggle-table-btn"
                data-target="overallTableBody">
                <i class="fas fa-chevron-up"></i>
              </button>
            </div>
            <div class="card-body" id="overallTableBody">
              <div class="table-responsive">
                <table
                  class="table table-striped table-hover table-bordered align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th>#</th>
                      <th class="question-col">Pitanje</th>
                      <th>N</th>
                      <th>AS</th>
                      <th>SD</th>
                      <th>Medijan</th>
                      <th>Ske</th>
                      <th>Kur</th>
                      <th>Max D</th>
                      <th>K-S p</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in results.overall %}
                    <tr class="result-row">
                      <td>{{ loop.index }}</td>
                      <td class="question-col">{{ row.question }}</td>
                      <td>{{ row.N }}</td>
                      <td>{{ row.AS }}</td>
                      <td>{{ row.SD }}</td>
                      <td>{{ row.Median }}</td>
                      <td>{{ row.Ske }}</td>
                      <td>{{ row.Kur }}</td>
                      <td>{{ row['Max D'] }}</td>
                      <td>{{ row['K-S p'] }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grouped Results -->
    {% for group_key, group_info in results.groupings.items() %}
    <div
      id="section-{{ group_key }}"
      class="results-group"
      style="display: none">
      <div class="row justify-content-center">
        <div class="col-lg-12">
          <div class="alert alert-info">
            <i class="fas fa-layer-group me-2"></i>
            <strong>Grupirano prema:</strong> {{ group_info.column }}
            <br /><small
              >Prikazana je zasebna statistika za svaku kategoriju: {{
              group_info.label|lower }}</small
            >
          </div>

          {% for group_value, group_stats in results.grouped[group_key].items()
          %}
          <div class="card results-table-card mb-4">
            <div
              class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fas fa-users me-2"></i>
                {{ group_value }}
                <span class="badge bg-light text-dark ms-2"
                  >{{ group_stats|length }} pitanja</span
                >
              </h5>
              <button
                class="btn btn-sm btn-outline-light toggle-table-btn"
                data-target="group-{{ group_key }}-{{ loop.index }}">
                <i class="fas fa-chevron-up"></i>
              </button>
            </div>
            <div class="card-body" id="group-{{ group_key }}-{{ loop.index }}">
              <div class="table-responsive">
                <table
                  class="table table-striped table-hover table-bordered table-sm align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th>#</th>
                      <th class="question-col">Pitanje</th>
                      <th>N</th>
                      <th>AS</th>
                      <th>SD</th>
                      <th>Medijan</th>
                      <th>Ske</th>
                      <th>Kur</th>
                      <th>Max D</th>
                      <th>K-S p</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in group_stats %}
                    <tr class="result-row">
                      <td>{{ loop.index }}</td>
                      <td class="question-col">{{ row.question }}</td>
                      <td>{{ row.N }}</td>
                      <td>{{ row.AS }}</td>
                      <td>{{ row.SD }}</td>
                      <td>{{ row.Median }}</td>
                      <td>{{ row.Ske }}</td>
                      <td>{{ row.Kur }}</td>
                      <td>{{ row['Max D'] }}</td>
                      <td>{{ row['K-S p'] }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- Scroll to top button -->
    <div class="text-center mt-4">
      <button class="btn btn-outline-primary btn-lg" id="backToTop">
        <i class="fas fa-arrow-up me-2"></i>Natrag na vrh
      </button>
    </div>
  </div>
</section>
{% endif %} {% endblock %} {% block extra_js %}
<script>
  $(document).ready(function() {

      // ===== File input preview =====
      var detectionDone = false;

      $('#csv_file').on('change', function() {
          var file = this.files[0];
          if (file) {
              var sizeMB = (file.size / (1024 * 1024)).toFixed(2);
              $('#fileName').text(file.name);
              $('#fileSize').text(sizeMB + ' MB');
              $('#fileInfo').hide().removeClass('d-none').slideDown(300, 'linear');
          } else {
              $('#fileInfo').slideUp(300, 'linear', function() { $(this).addClass('d-none'); });
          }
          // Reset detection state when file changes
          if (detectionDone) {
              detectionDone = false;
              $('#columnSelectionCard').slideUp(300, 'linear');
              $('input.hidden-group').remove();
              $('#submitBtn').show().prop('disabled', false)
                  .html('<i class="fas fa-upload me-2"></i> Učitaj i izračunaj');
          }
      });

      // ===== Form submit — detect groupable columns via AJAX =====
      $('#uploadForm').on('submit', function(e) {
          e.preventDefault();

          var fileInput = $('#csv_file')[0];
          if (!fileInput.files.length) return;

          var $btn = $('#submitBtn');
          $btn.prop('disabled', true);
          $btn.html('<i class="fas fa-spinner fa-spin me-2"></i> Analiziram stupce...');

          var formData = new FormData();
          formData.append('csv_file', fileInput.files[0]);

          $.ajax({
              url: '{{ url_for("main.detect_columns") }}',
              method: 'POST',
              data: formData,
              processData: false,
              contentType: false,
              success: function(data) {
                  detectionDone = true;
                  if (data.columns && data.columns.length > 0) {
                      showColumnSelection(data.columns);
                      $btn.hide();
                  } else {
                      // No groupable columns — calculate overall only
                      $btn.html('<i class="fas fa-spinner fa-spin me-2"></i> Obrađujem...');
                      submitCalculation([]);
                  }
              },
              error: function(xhr) {
                  var msg = 'Greška pri analizi stupaca.';
                  try { msg = JSON.parse(xhr.responseText).error; } catch(ex) {}
                  var $alert = $('<div class="alert alert-danger alert-dismissible fade show mt-3">'
                      + '<i class="fas fa-exclamation-triangle me-2"></i>' + $('<span>').text(msg).html()
                      + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
                  $('.upload-card').after($alert);
                  $btn.prop('disabled', false);
                  $btn.html('<i class="fas fa-upload me-2"></i> Učitaj i izračunaj');
              }
          });
      });

      // ===== Column selection helpers =====
      function showColumnSelection(columns) {
          var $container = $('#columnCheckboxes');
          $container.empty();

          columns.forEach(function(col, index) {
              var $div = $('<div class="form-check form-switch mb-2">');
              var $input = $('<input class="form-check-input grouping-checkbox" type="checkbox">')
                  .attr({ id: 'grp_' + index, value: col });
              var $label = $('<label class="form-check-label">')
                  .attr('for', 'grp_' + index).text(col);
              $div.append($input).append($label);
              $container.append($div);
          });

          updateSelectedCount();
          $('#columnSelectionCard').hide().removeClass('d-none').slideDown(400, 'linear');
          $('html, body').animate({ scrollTop: $('#columnSelectionCard').offset().top - 100 }, 400, 'linear');
      }

      function updateSelectedCount() {
          var count = $('.grouping-checkbox:checked').length;
          var total = $('.grouping-checkbox').length;
          $('#selectedCount').text(count + ' od ' + total + ' odabrano');
      }

      $(document).on('change', '.grouping-checkbox', updateSelectedCount);

      $('#selectAllBtn').on('click', function() {
          $('.grouping-checkbox').prop('checked', true);
          updateSelectedCount();
      });

      $('#deselectAllBtn').on('click', function() {
          $('.grouping-checkbox').prop('checked', false);
          updateSelectedCount();
      });

      function submitCalculation(selectedColumns) {
          var $form = $('#uploadForm');
          $form.find('input.hidden-group').remove();
          selectedColumns.forEach(function(col) {
              $form.append($('<input type="hidden" name="selected_groups" class="hidden-group">').val(col));
          });
          $('#calculateBtn').prop('disabled', true)
              .html('<i class="fas fa-spinner fa-spin me-2"></i> Obrađujem...');
          $('#skipGroupingBtn').prop('disabled', true);
          $form[0].submit();
      }

      $('#calculateBtn').on('click', function() {
          var selected = [];
          $('.grouping-checkbox:checked').each(function() {
              selected.push($(this).val());
          });
          submitCalculation(selected);
      });

      $('#skipGroupingBtn').on('click', function() {
          submitCalculation([]);
      });

      // ===== Grouping selector with slide animation =====
      $('#groupingSelect').on('change', function() {
          var selectedValue = $(this).val();

          // Fade out current visible group
          $('.results-group:visible').fadeOut(250, 'linear', function() {
              // Fade in the selected group
              $('#section-' + selectedValue).fadeIn(400, 'linear');
          });
      });

      // ===== Toggle legend panel =====
      $('#toggleLegend').on('click', function() {
          $('#legendPanel').slideToggle(300, 'linear');
          $(this).toggleClass('active');
      });

      // ===== Collapse/expand table bodies =====
      $(document).on('click', '.toggle-table-btn', function() {
          var targetId = $(this).data('target');
          var $target = $('#' + targetId);
          var $icon = $(this).find('i');

          $target.slideToggle(350, 'linear', function() {
              if ($target.is(':visible')) {
                  $icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
              } else {
                  $icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
              }
          });
      });

      // ===== Animate result rows on load =====
      {% if results %}
      // Hide upload cards and column selection when results are displayed
      $('.instruction-card, .upload-card').hide();
      $('#columnSelectionCard').hide();

      $('.results-group.active .result-row').each(function(index) {
          $(this).css({ opacity: 0, transform: 'translateY(15px)' });
          $(this).delay(index * 30).animate({ opacity: 1 }, 300, 'linear', function() {
              $(this).css('transform', 'translateY(0)');
          });
      });

      // Smooth scroll to results after upload
      $('html, body').animate({
          scrollTop: $('#results-section').offset().top - 80
      }, 600, 'linear');
      {% endif %}

      // ===== Error alert auto-dismiss =====
      {% if error %}
      setTimeout(function() {
          $('#errorAlert').fadeOut(500, 'linear');
      }, 8000);
      {% endif %}

      // ===== Back to top button =====
      $('#backToTop').on('click', function() {
          $('html, body').animate({ scrollTop: 0 }, 500, 'linear');
      });

      // ===== Reset / Load new data =====
      $('#resetBtn').on('click', function() {
          detectionDone = false;
          $('#results-section').slideUp(400, 'linear');
          $('#columnSelectionCard').slideUp(300, 'linear');
          $('input.hidden-group').remove();
          $('.instruction-card, .upload-card').slideDown(400, 'linear');
          $('#uploadForm')[0].reset();
          $('#fileInfo').addClass('d-none');
          $('#submitBtn').show().prop('disabled', false)
              .html('<i class="fas fa-upload me-2"></i> Učitaj i izračunaj');
          $('html, body').animate({ scrollTop: $('#upload-section').offset().top - 80 }, 400, 'linear');
      });

      // ===== Initialize Bootstrap popovers =====
      var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
      popoverTriggerList.map(function (el) { return new bootstrap.Popover(el); });

      // ===== AI Analysis AJAX =====
      $('#aiAnalysisBtn').on('click', function() {
          var $btn = $(this);
          $btn.prop('disabled', true);
          $btn.html('<i class="fas fa-spinner fa-spin"></i>');

          // Show card with spinner, hide previous result/error
          $('#aiResult').hide();
          $('#aiError').hide();
          $('#aiSpinner').show();
          $('#aiCardWrapper').slideDown(350, 'linear');

          // Read analysis data embedded in the page
          var analysisData = JSON.parse($('#analysisData').text());

          $.ajax({
              url: '{{ url_for("main.ai_analysis") }}',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify(analysisData),
              success: function(data) {
                  $('#aiSpinner').slideUp(200, 'linear', function() {
                      if (data.interpretation) {
                          $('#aiResultText').html(data.interpretation);
                          $('#aiResult').fadeIn(300, 'linear');
                          $btn.fadeOut(300, 'linear');
                      }
                  });
              },
              error: function(xhr) {
                  $('#aiSpinner').slideUp(200, 'linear', function() {
                      var msg = 'Došlo je do pogreške s AI analizom. Molimo pokušajte kasnije.';
                      try {
                          var resp = JSON.parse(xhr.responseText);
                          if (resp.error) msg = resp.error;
                      } catch(e) {}
                      $('#aiErrorText').text(msg);
                      $('#aiError').fadeIn(300, 'linear');
                  });
                  $btn.prop('disabled', false);
                  $btn.html('<i class="fas fa-wand-magic-sparkles"></i>');
              }
          });
      });

      // ===== Toggle AI card body =====
      $('#toggleAiBody').on('click', function() {
          var $icon = $(this).find('i');
          $('#aiCardBody').slideToggle(300, 'linear', function() {
              if ($(this).is(':visible')) {
                  $icon.removeClass('fa-eye-slash').addClass('fa-eye');
              } else {
                  $icon.removeClass('fa-eye').addClass('fa-eye-slash');
              }
          });
      });

      // ===== Copy AI prompt to clipboard =====
      $('#copyPromptBtn').on('click', function() {
          var analysisData = JSON.parse($('#analysisData').text());
          var statsJson = JSON.stringify(analysisData.overall, null, 2);

          var prompt = 'You are a statistics expert. A user conducted a Likert-scale (1-5) survey. '
              + 'Below are the calculated descriptive statistics for each question.\n\n'
              + 'Statistical abbreviations:\n'
              + '- N = number of respondents\n'
              + '- AS = arithmetic mean\n'
              + '- SD = standard deviation\n'
              + '- Median = median value\n'
              + '- Ske = skewness\n'
              + '- Kur = kurtosis\n'
              + '- Max D = Kolmogorov-Smirnov statistic\n'
              + '- K-S p = Kolmogorov-Smirnov p-value\n\n'
              + 'Overall statistics:\n' + statsJson + '\n';

          if (analysisData.grouped && analysisData.groupings) {
              var groupedJson = JSON.stringify(analysisData.grouped, null, 2);
              prompt += '\nGrouped statistics by demographics:\n' + groupedJson + '\n';
          }

          prompt += '\nProvide a detailed and thorough interpretation. '
              + 'Highlight which questions scored highest/lowest, whether responses '
              + 'are normally distributed, and any notable patterns. '
              + 'Answer in the SAME LANGUAGE as the question text.';

          navigator.clipboard.writeText(prompt).then(function() {
              var $btn = $('#copyPromptBtn');
              var original = $btn.html();
              $btn.html('<i class="fas fa-check me-1"></i>Kopirano!');
              $btn.removeClass('btn-outline-secondary').addClass('btn-success');
              setTimeout(function() {
                  $btn.html(original);
                  $btn.removeClass('btn-success').addClass('btn-outline-secondary');
              }, 2000);
          });
      });

      // ===== Navbar shrink on scroll =====
      $(window).on('scroll', function() {
          var $nav = $('#mainNav');
          if ($(window).scrollTop() > 50) {
              $nav.addClass('navbar-shrink');
          } else {
              $nav.removeClass('navbar-shrink');
          }
      }).trigger('scroll');
  });
</script>
{% endblock %}
